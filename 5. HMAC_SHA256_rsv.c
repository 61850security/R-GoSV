#include <arpa/inet.h>
#include <linux/if_packet.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <net/if.h>
#include <netinet/ether.h>
#include <unistd.h>
#include <openssl/hmac.h>
#include <openssl/evp.h>

/* Session layer fields */
char session_id = 0xA2; 
char length_id = 0x18;  
char common_header= 0x80;
char l_id = 0x16; 
char spdu_length1=0x00; 
char spdu_length2=0x00; 
char spdu_length3=0x00; 
char spdu_length4=0xA4;
char spdu_num1=0x00;    
char spdu_num2=0x00;
char spdu_num3=0x00;
char spdu_num4=0x0C;
char ver1=0x00;
char ver2=0x01;
char TimeofCurrentKey1=0x5B; 
char TimeofCurrentKey2=0xFC; 
char TimeofCurrentKey3=0xF6;
char TimeofCurrentKey4=0xB0;
char TimeofNextKey1=0x00;
char TimeofNextKey2=0x3C; 
char sa1=0x02; 
char sa2=0x03; 
char keyID1=0x00; 
char keyID2=0x00;
char keyID3=0x00;
char keyID4=0x0D;
char len1=0x00; 
char len2=0x00;
char len3=0x00;
char len4=0x6C;
char pl_type=0x82; 
char simulation=0x01; 
char APPID1=0x00;
char APPID2=0x01;
char length1=0x00; 
char length2=0x66;



/* Sample VAlue fields according to IEC 61850-9-2 */
char sav_PDU_tag=0x60;               /* sav_PDU tag  */
char sav_PDU_length=0x64; 	     /* sav_PDU length - size of APDU */
char noASDU_tag=0x80;		     /* number of ASDU tag  */ 
char noASDU_length=0x01;             /* number of ASDU length */
char noASDU=0x01;                    /* noASDU value  */
char SequenceofASDU_tag=0xA2;        /* SequenceofASDU tag   */
char SequenceofASDU_length=0x5F;     /* SequenceofASDU length - size of all ASDU  */
char ASDU_tag=0x30;                  /* ASDU tag */
char ASDU_length=0x5D;               /* ASDU length */
char svID_tag =0x80;                 /* Sample Value identifier tag   */
char svID_length =0x0C;              /* Sample Value identifier length */
char svID_1=0x46;                    /*  svID[12] naming   */
char svID_2=0x52;
char svID_3=0x45;
char svID_4=0x41;
char svID_5=0x2D;
char svID_6=0x47;
char svID_7=0x6F;
char svID_8=0x53;
char svID_9=0x56;
char svID_10=0x2D;  
char svID_11=0x31;
char svID_12=0x20;
char smpCnt_tag=0x82;                /* sample count tag */
char smpCnt_length =0x02;            /* sample count length */
char smpCnt_1=0x00;                  /* sample count */
char smpCnt_2=0x08;
char confRev_tag=0x83;               /* confRev tag - configuratin revision number */
char confRev_length=0x04;            /* confRev length */
char confRev1=0x00;                  /* confRev value */
char confRev2=0x00; 	     
char confRev3=0x00;
char confRev4=0x01;                   
char smpSynch_tag = 0x85;            /* smpSynch tag -synchronization identifier */
char smpSynch_length =0x01;          /* smpSynch_length */
char smpSynch =0x00; 		     /* smpSynch value  */
char SequenceofData_tag =0x87;       /* SequenceofData tag */
char SequenceofData_length=0x40;     /* SequenceofData length */

/* Enter your custom measurement values in hexa decimal    */
char a[64]=     { 0x00, 0x00, 0x00, 0x5A, 0x12, 0x15, 0x12, 0x64,
                  0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 0x16, 
		  0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64,
                  0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 0x16, 
		  0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64,
                  0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 0x16, 
		  0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64,
                  0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 0x16 };

int main(int argc, char *argv[])
{
    
    int j=0;
    unsigned char Data[138];
    unsigned char key[32]= { 
			0xee, 0xbc, 0x1f, 0x57, 0x48, 0x7f, 0x51, 0x92, 0x1c, 0x04, 0x65, 0x66, 0x5f, 0x8a, 0xe6, 0xd1,
                        0x65, 0x8b, 0xb2, 0x6d, 0xe6, 0xf8, 0xa0, 0x69, 0xa3, 0x52, 0x02, 0x93, 0xa5, 0x72, 0x07, 0x8f 
			   };
    unsigned char *hash,hash_string[32];
    unsigned char signature_data[138]=
   				{
					0xA2, 0x18, 0x80, 0x16, 0x00, 0x00, 0x00, 0xA4, 0x00, 0x00, 0x00, 0x0C, 0x00, 0x01, 0x5B, 
					0xFC, 0xF6, 0xB0, 0x00, 0x3C, 0x02, 0x03, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x6C,
					0x82, 0x01, 0x00, 0x01, 0x00, 0x66, 0x60, 0x64, 0x80, 0x01, 0x01, 0xA2, 0x5F, 0x30, 0x5D,
					0x80, 0x0C, 0x46, 0x52, 0x45, 0x41, 0x2D, 0x47, 0x6F, 0x53, 0x56, 0x2D, 0x31, 0x20, 0x82,
					0x02, 0x00, 0x08, 0x83, 0x04, 0x00, 0x00, 0x00, 0x01, 0x85, 0x01, 0x00, 0x87, 0x40, 0x00, 
					0x00, 0x00, 0x5A, 0x12, 0x15, 0x12, 0x64, 0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 0x16,
                                        0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64, 0x11, 0x12, 0x18, 0x22, 0x14, 0x12, 0x17, 
                                        0x16, 0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64, 0x11, 0x12, 0x18, 0x22, 0x14, 0x12,
                                        0x17, 0x16, 0x30, 0x42, 0x10, 0x14, 0x12, 0x15, 0x12, 0x64, 0x11, 0x12, 0x18, 0x22, 0x14,
                                        0x12, 0x17, 0x16
				}; 
    for ( j=0; j<138; j++)
    {
	sprintf( &(Data[j * 2]) , "%02x", signature_data[j]); 
        //printf(" %s",Data);
    }
    hash = HMAC(EVP_sha256(), key, strlen((char *)key), signature_data, strlen((char *) signature_data), NULL, NULL);

    for (j = 0; j < 32 ; j++)
	sprintf(&(hash_string[j * 2]), "%02x", hash[j]);
    printf("\n \n Hash value: %s \n", hash_string);
    
    
   return 0;
}
	
